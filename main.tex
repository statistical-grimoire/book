%==============================================================================
% Document Class and Basic Settings
%==============================================================================
\documentclass[11pt,a4paper]{book}

%==============================================================================
% Page Geometry and Spacing
%==============================================================================
\usepackage{geometry}
\geometry{
  a4paper,
  total = {170mm,257mm},
  left = 20mm,
  top = 20mm,
}
\setlength{\footnotesep}{\baselineskip}
\raggedbottom
\usepackage[bottom]{footmisc}

%==============================================================================
% Math Packages
%==============================================================================
\usepackage{amsmath,amssymb,amsfonts}

%==============================================================================
% Font Setup and Custom Fonts
%==============================================================================
\usepackage{fontspec}

% Uncomment to use CourierPrime
% \setmonofont{CourierPrime}[
%     Path=./fonts/Courier_Prime/,
%     Extension = .ttf,
%     UprightFont=*-Regular,
%     BoldFont=*-Bold,
%     ItalicFont=*-Italic,
%     BoldItalicFont=*-BoldItalic
% ]

\setmonofont{SourceCodePro}[
    Path=./fonts/SourceCodePro/,
    Scale=0.90,
    Extension = .ttf,
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    BoldItalicFont=*-BoldItalic
]

\newfontfamily\IMFellEnglish[
    Path=./fonts/IMFellEnglish/,
    Extension = .ttf,
    UprightFont=*-Regular,
    ItalicFont=*-Italic
]{IMFellEnglish}

%==============================================================================
% Section and Title Formatting
%==============================================================================
\usepackage{titlesec}
\usepackage{titling}

% Define a custom font for headings
\newfontfamily\headingfont[
    Path=./fonts/IMFellEnglish/,
    Extension = .ttf,
    UprightFont=*-Regular,
    ItalicFont=*-Italic
]{IMFellEnglish}

% Format Part titles to be similar to chapters
\titleclass{\part}{top}
\titleformat{\part}[display]
  {\centering\headingfont\Huge}
  {\MakeUppercase{\partname} \thepart}
  {0pt}
  {\titlerule[2pt]\vspace{1pc}\huge}
\titlespacing*{\part}{0pt}{0pt}{20pt}

% Format Chapter titles
\titleformat{\chapter}[display]
  {\headingfont\huge}
  {\chaptertitlename\ \thechapter}
  {20pt}
  {\Huge}

% Format Sections and Subsections
\titleformat*{\section}{\LARGE\headingfont}
\titleformat*{\subsection}{\Large\headingfont}
\titleformat*{\subsubsection}{\large\headingfont}

%==============================================================================
% Graphics, Figures, and Captions
%==============================================================================
\usepackage{graphicx}
\graphicspath{{graphics/}}
\usepackage{svg}
\usepackage{wrapfig}
\usepackage{caption}
\captionsetup[figure]{font=footnotesize, labelfont=footnotesize}
\captionsetup[table]{font=footnotesize, labelfont=footnotesize}
\captionsetup[listing]{font=footnotesize, labelfont=footnotesize}

%==============================================================================
% Spacing, Lists, and Tables
%==============================================================================
\usepackage{setspace}
\usepackage[skip=10pt plus1pt, indent=1cm]{parskip}
\usepackage{booktabs}
\usepackage{enumitem}

%==============================================================================
% Bibliography and Citations
%==============================================================================
%\usepackage[square, sort&compress]{natbib}
\usepackage[style=apa,sortcites=true,sorting=nyt,backend=biber]{biblatex}
\addbibresource{backmatter/bib.bib}
\AtBeginBibliography{\small}

%==============================================================================
% Page Headers and Footers
%==============================================================================
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.~#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}
\fancyhf{}
\fancyhead[RE,LO]{\thepage}
\fancyhead[LE]{\nouppercase{\leftmark}}
\fancyhead[RO]{\nouppercase{\rightmark}}
% Uncomment to adjust header rule
% \renewcommand{\headrulewidth}{0.5pt}

%==============================================================================
% Decorative and Additional Font Packages
%==============================================================================
\usepackage{Zallman, lettrine}
\usepackage{GoudyIn}
\usepackage{xcolor, colortbl}
\usepackage{soul}
\definecolor{crimson}{RGB}{86,8,24}
\definecolor{black}{RGB}{0,0,0}
%\renewcommand{\LettrineFontHook}{\color{black}\GoudyInfamily{}}
%https://tex.stackexchange.com/questions/250474/how-to-use-fancy-dropcaps-with-pdflatex
\renewcommand{\LettrineFontHook}{\color{black}\Zallmanfamily{}}
\LettrineTextFont{\itshape}
\setcounter{DefaultLines}{3}%

%==============================================================================
% Hyperlinks
%==============================================================================
\usepackage[hidelinks]{hyperref}

%==============================================================================
% Index and Glossaries
%==============================================================================
\usepackage{makeidx}
\makeindex
\usepackage[toc, nopostdot]{glossaries}
\renewcommand*{\glstextformat}{\textbf}
\makeglossaries
\input{backmatter/glossary}

%==============================================================================
% Other Useful Packages
%==============================================================================
\usepackage[nottoc]{tocbibind}
\usepackage{emptypage}
\usepackage{adjustbox}
\usepackage{lipsum}
% Uncomment if you want to use colored boxes
% \usepackage{tcolorbox}

% Code Colors Definition
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{RGB}{236,236,236}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolourIN}{rgb}{0.95,0.95,0.92}
\definecolor{backcolourOUT}{RGB}{255,255,255}
\definecolor{darkgray}{RGB}{30,30,30}       % Dark gray background
\definecolor{deepred}{RGB}{150,0,0}    % Deep red border
\definecolor{white}{RGB}{255,255,255}  % White text

% Include minted configuration for code listings
\input{mainmatter/mintedPkg}

% mdframed settings for custom frames
\usepackage[framemethod=TikZ]{mdframed}
\mdfdefinestyle{miscFrame}{%
    frametitleaboveskip = 20pt,
    linecolor = darkgray,
    outerlinewidth = 1pt,
    roundcorner = 2pt,
    innertopmargin = \baselineskip,
    innerbottommargin = \baselineskip,
    innerrightmargin = 20pt,
    innerleftmargin = 20pt,
    backgroundcolor = backcolourIN,
    skipabove=\baselineskip,
    skipbelow=\baselineskip
    % nobreak = true
}

\usepackage{float}
%\usepackage{dblfloatfix} % Uncomment if needed
\usepackage{csquotes}
\usepackage{dirtree}
\usepackage{fontawesome5}
\usepackage{fourier-orns}
\usepackage{tikzsymbols}
\usepackage[style=iso]{datetime2}

%==============================================================================
% Begin Document
%==============================================================================
\begin{document}

%----------------------------------------------------------------------------
% FRONTMATTER: title pages, preface, table of contents, etc.
%----------------------------------------------------------------------------
\frontmatter
\pagestyle{empty}
\singlespacing

\include{frontmatter/frontispiece}
\include{frontmatter/title}
\include{frontmatter/colophon}
\include{frontmatter/dedication}

\pagestyle{plain}
\onehalfspacing
\include{frontmatter/preface}
\tableofcontents

%----------------------------------------------------------------------------
% MAINMATTER: the main content of the textbook
%----------------------------------------------------------------------------
\mainmatter
\pagestyle{fancy}
\onehalfspacing

\include{mainmatter/part_1}
\include{mainmatter/ch1}
\include{mainmatter/ch2}
\include{mainmatter/ch3}
% \include{mainmatter/ch4}  % Uncomment when ready

\printglossary[type=main, nonumberlist]

%----------------------------------------------------------------------------
% APPENDIX
%----------------------------------------------------------------------------
\appendix
\include{backmatter/app1}
\include{backmatter/app2}

%----------------------------------------------------------------------------
% BACKMATTER: bibliography, index, postface, etc.
%----------------------------------------------------------------------------
\backmatter
\pagestyle{fancy}
\singlespacing

\setlength\bibitemsep{1em}
\printbibliography[heading=bibintoc, title={References}]

\cleardoublepage
\phantomsection
% \printindex  % Uncomment if index is needed
% \include{backmatter/postface}  % Uncomment if you have a postface

\end{document}
